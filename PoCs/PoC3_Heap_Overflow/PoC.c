#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#define MAX_BUFFER_SIZE 1000  // 최대 버퍼 크기 제한

// 실질적인 연산은 size << 0으로 size 반환버그로 인해 실제로는 0 반환 but 버그로 인해서 0 반환
int global_mask = 0xffff;
#define BUFFER_SIZE_CALCULATION(size) ((size) << (((global_mask & 0x100)) - 0x100)) 


int validateBufferSize(int size) {
    // 버퍼 크기가 음수가 아니고 최대치를 넘지 않는지 검증
    if (size > 0 && size <= MAX_BUFFER_SIZE) {
        // 버그를 통해 실제 버퍼 크기를 0으로 설정
        return BUFFER_SIZE_CALCULATION(size); // 버그를 통해 실제 버퍼 크기를 0으로 설정
    } else {
        // 잘못된 크기 입력에 대한 처리
        printf("Invalid buffer size. Please enter a size between 1 and %d.\n", MAX_BUFFER_SIZE);
        return -1;
    }
}

int main() {
    int userBufferSize;
    printf("Enter the buffer size you want to allocate: ");
    scanf("%d", &userBufferSize); // 사용자로부터 버퍼 크기 입력 받음

    int bufferSize = validateBufferSize(userBufferSize); // 실제 버퍼 크기 계산 (버그로 인해 0)
    if (bufferSize < 0) {
        return 1; // 잘못된 입력 처리
    }
    
    printf("buffer size: %d\n", bufferSize);  // 버그가 발생했음을 명시적으로 확인하기 위함

    // 사용자가 입력한 크기와 무관하게 실제 할당은 버그에 의해 결정됨
    char *buffer = (char *)malloc(bufferSize);
    if (!buffer) {
        perror("Failed to allocate buffer");
        return 1;
    }

    // 데이터 입력 받기
    printf("Enter your data: ");
    getchar(); // 이전 입력의 newline 제거
    fgets(buffer, userBufferSize, stdin); // 사용자가 입력한 크기로 데이터 입력 받음

    printf("You entered: %s\n", buffer);

    free(buffer);
    return 0;
}